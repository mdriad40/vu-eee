<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EEE Routine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <!-- Early Lottie animation preload and cache - runs immediately -->
    <script>
      (function() {
        // Cache key for landing animation
        const LANDING_ANIMATION_CACHE_KEY = 'cse.landingAnimationData';
        const LANDING_ANIMATION_PATH = 'animation_file/loading.json';
        const CACHE_VERSION = '1'; // Increment to invalidate cache
        
        // Preload and cache landing animation JSON immediately
        function preloadLandingAnimation() {
          // Check if cached data exists
          try {
            const cached = localStorage.getItem(LANDING_ANIMATION_CACHE_KEY);
            const cachedVersion = localStorage.getItem(LANDING_ANIMATION_CACHE_KEY + '.version');
            if (cached && cachedVersion === CACHE_VERSION) {
              // Cache exists, store in global variable for instant access
              window.__landingAnimationData = JSON.parse(cached);
              return;
            }
          } catch (e) {
            // Cache invalid, fetch fresh
          }
          
          // Fetch and cache animation data
          fetch(LANDING_ANIMATION_PATH)
            .then(response => {
              if (!response.ok) return;
              return response.json();
            })
            .then(animationData => {
              if (animationData) {
                try {
                  // Store in localStorage for next time
                  localStorage.setItem(LANDING_ANIMATION_CACHE_KEY, JSON.stringify(animationData));
                  localStorage.setItem(LANDING_ANIMATION_CACHE_KEY + '.version', CACHE_VERSION);
                  // Store in global variable for instant access
                  window.__landingAnimationData = animationData;
                } catch (e) {
                  // localStorage full or blocked, just use in-memory
                  window.__landingAnimationData = animationData;
                }
              }
            })
            .catch(() => {
              // Silently fail, will use path fallback
            });
        }
        
        // Start preloading immediately
        preloadLandingAnimation();
      })();
    </script>
</head>
<body>
    <div id="app">
        <!-- Landing Screen -->
        <section id="landing" class="screen"> 
            <div class="landing-card card">
                <div id="lottie" class="lottie"></div>
                <h1 class="app-title">VU Class Routine</h1>
                <div class="selectors">
                    <label class="field control">
                        <span>Department</span>
                        <select id="department" class="dropdown">
                            <option value="">Select Department</option>
                        </select>
                    </label>
                        <label class="field control">
                        <span>Semester</span>
                        <select id="semester" class="dropdown">
                            <option value="">Select Semester</option>
                            <option value="1-1">1st</option>
                            <option value="1-2">2nd</option>
                            <option value="2-1">3rd</option>
                            <option value="2-2">4th</option>
                            <option value="3-1">5th</option>
                            <option value="3-2">6th</option>
                            <option value="4-1">7th</option>
                            <option value="4-2">8th</option>
                        </select>
                    </label>
                    <label class="field control">
                        <span>Section</span>
                        <select id="section" class="dropdown" disabled>
                            <option value="">Select Section</option>
                        </select>
                    </label>
                </div>
                <button id="getSchedule" class="primary-btn">Get Schedule</button>
                <p id="landingError" class="error-text" aria-live="polite"></p>
            </div>
        </section>

        <!-- Global Student Loading Overlay (shown before student data fully loads) -->
        <div id="studentLoadingOverlay" class="student-loading-overlay">
            <div class="student-loading-backdrop"></div>
            <div class="student-loading-content">
                <div class="custom-loader">
                    <svg class="custom-loader-svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="loaderGradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#9E8CFF;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#6C6BFF;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#C5C6FF;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="loaderGradient2" x1="100%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#C5C6FF;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#9E8CFF;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#6C6BFF;stop-opacity:0.8" />
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <!-- Outer rotating arc - Gap Control: Change r="48" to adjust gap (current gap: 10px between circles) -->
                        <circle class="custom-loader-arc custom-loader-arc-outer" cx="60" cy="60" r="48" fill="none" stroke="url(#loaderGradient1)" stroke-linecap="round" filter="url(#glow)" />
                        <!-- Middle rotating arc - Gap Control: Change r="38" to adjust gap -->
                        <circle class="custom-loader-arc custom-loader-arc-middle" cx="60" cy="60" r="38" fill="none" stroke="url(#loaderGradient2)" stroke-linecap="round" />
                        <!-- Inner rotating arc - Gap Control: Change r="28" to adjust gap -->
                        <circle class="custom-loader-arc custom-loader-arc-inner" cx="60" cy="60" r="28" fill="none" stroke="url(#loaderGradient1)" stroke-linecap="round" />
                    </svg>
                </div>
            <!-- <div class="student-loading-text">Loading your schedule...</div> -->
            </div>
        </div>

        <!-- Student Routine Screen -->
        <section id="student" class="screen hidden">
            <header class="main-header">
                <div class="header-title">Student Schedule</div>
            </header>
            
            <div class="selection-controls card">
                <div class="control">
                    <label>Department</label>
                    <select id="departmentDisplay" class="dropdown">
                        <option value="">Select Department</option>
                    </select>
                </div>
                <div class="control">
                    <label>Semester</label>
                    <select id="semesterDisplay"></select>
                </div>
                <div class="control">
                    <label>Section</label>
                    <select id="sectionDisplay" disabled></select>
                </div>
            </div>

            <div class="content">
                <div class="details card">
                    <div class="details-row">
                        <div>
                            <div class="muted">Semester</div>
                            <div id="detailsSemester" class="accent"></div>
                        </div>
                        <div>
                            <div class="muted">Section</div>
                            <div id="detailsSection" class="accent"></div>
                        </div>
                        <div>
                            <div class="muted">Total Courses</div>
                            <div id="detailsTotal" class="accent"></div>
                        </div>
                        <div>
                            <div class="muted">Routine Version</div>
                            <div id="detailsVersion" class="accent">Fall 2025 v1</div>
                        </div>
                        <div>
                            <div class="muted">CR</div>
                            <div id="detailsCR1" class="accent"></div>
                        </div>
                        <div>
                            <div class="muted">CR</div>
                            <div id="detailsCR2" class="accent"></div>
                        </div>
                    </div>
                </div>

                <div class="days scroller" id="dayScroller" role="tablist" aria-label="Days">
                    <!-- Days injected by JS -->
                </div>

                <div id="dateToday" class="date-today"></div>

                <div id="scheduleContainer" class="schedule">
                    <!-- Cards injected by JS -->
                </div>

                <div id="emptyMessage" class="empty hidden">
                    <div class="empty-title">Enjoy your day -- No class Today!</div>
                    <div id="emptyLottie" class="empty-lottie"></div>
                </div>
                <div id="networkMessage" class="empty hidden">Network error.</div>
            </div>
        </section>

        <!-- Teacher Routine Screen -->
        <section id="teacher" class="screen hidden">
            <header class="main-header">
                <div class="header-title">Teacher Schedule</div>
            </header>
            
            <div class="selection-controls card">
                <div class="control teacher-search-wrapper">
                    <label>Teacher</label>
                    <div class="autocomplete-container">
                        <input type="text" id="teacherSearch" placeholder="Enter Teacher Initial: MRH" autocomplete="off" spellcheck="false" />
                        <div id="teacherSuggestions" class="autocomplete-dropdown hidden"></div>
                    </div>
                </div>
                <div class="control teacher-department-wrapper">
                    <label>Department</label>
                    <select id="teacherDepartment">
                        <option value="">Select Department</option>
                    </select>
                </div>
            </div>

            <div class="content">
                <div class="details card">
                    <div class="details-row">
                        <div>
                            <div class="muted">Teacher</div>
                            <div id="teacherDetailsName" class="accent"></div>
                        </div>
                        <div>
                            <div class="muted">Batch</div>
                            <div id="teacherDetailsBatch" class="accent"></div>
                        </div>
                        <div>
                            <div class="muted">Total Course</div>
                            <div id="teacherDetailsTotal" class="accent"></div>
                        </div>
                        <div>
                            <div class="muted">Routine Version</div>
                            <div id="teacherDetailsVersion" class="accent">—</div>
                        </div>
                    </div>
                </div>

                <div>
                    <button id="teacherContactBtn" class="primary-btn small">Contact</button>
                </div>

                <div class="days scroller" id="teacherDayScroller" role="tablist" aria-label="Days">
                    <!-- Days injected by JS -->
                </div>

                <div id="teacherDateToday" class="date-today"></div>

                <div id="teacherScheduleContainer" class="schedule">
                    <!-- Cards injected by JS -->
                </div>

                <div id="teacherEmptyMessage" class="empty hidden">No classes scheduled for this day.</div>
                <div id="teacherNetworkMessage" class="empty hidden">Network error.</div>
            </div>

            <!-- Teacher Contact Popup -->
            <div id="teacherContactPopup" class="popup-overlay hidden">
                <div class="popup-content">
                    <div class="popup-header">
                        <h3 id="teacherContactTitle" class="popup-title"></h3>
                        <button class="popup-close" id="teacherContactClose">&times;</button>
                    </div>
                    <div class="popup-body">
                        <div class="contact-info-item">
                            <span class="contact-label">Designation:</span>
                            <span id="teacherContactDesignation" class="contact-value">—</span>
                        </div>
                        <div class="contact-info-item">
                            <span class="contact-label">Phone:</span>
                            <span id="teacherContactPhone" class="contact-value">—</span>
                        </div>
                        <div class="contact-info-item">
                            <span class="contact-label">Email:</span>
                            <span id="teacherContactEmail" class="contact-value">—</span>
                        </div>
                        <div class="contact-info-item">
                            <span class="contact-label">Department:</span>
                            <span id="teacherContactDepartment" class="contact-value">—</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="empty" class="screen hidden">
            <div class="placeholder">Empty page.</div>
        </section>
        <section id="query" class="screen hidden">
            <header class="main-header">
                <div class="header-title">Query</div>
            </header>
            <!-- Top Menu Bar -->
            <div class="query-menu-bar">
                <button class="query-menu-segment active" id="roomQueryTab" data-tab="room-query">
                    <svg class="query-menu-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span>Room Query</span>
                </button>
                <button class="query-menu-segment" id="crInfoTab" data-tab="cr-info">
                    <svg class="query-menu-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>CR Info</span>
                </button>
            </div>

            <!-- Room Query Interface -->
            <div id="roomQueryInterface" class="query-interface">
                <div class="selection-controls card room-query-selection">
                    <div class="control">
                        <label>Department</label>
                        <select id="roomQueryDepartment">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    <div class="control">
                        <label>Search By</label>
                        <select id="roomQuerySearchBy">
                            <option value="">Select Option</option>
                            <option value="room">Room No</option>
                            <option value="timeslot">Time Slot</option>
                        </select>
                    </div>
                    <div class="control" id="roomQueryThirdControl">
                        <label id="roomQueryThirdLabel">Select Option</label>
                        <select id="roomQueryThirdSelect" disabled>
                            <option value="">Search By</option>
                        </select>
                    </div>
                </div>
                <div id="roomQueryDaySelectorWrapper" class="hidden">
                    <div id="roomQueryDayTitle" class="room-query-day-title"></div>
                    <div class="days scroller" id="roomQueryDayScroller" role="tablist" aria-label="Days">
                        <!-- Days injected by JS -->
                    </div>
                    <div id="roomQueryDateToday" class="date-today"></div>
                </div>
                <div id="roomQueryResults" class="query-results"></div>
            </div>

            <!-- CR Info Interface -->
            <div id="crInfoInterface" class="query-interface hidden">
                <div class="selection-controls card">
                    <div class="control">
                        <label>Department</label>
                        <select id="crInfoDepartment">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    <div class="control">
                        <label>Semester</label>
                        <select id="crInfoSemester">
                            <option value="">Select Semester</option>
                            <option value="1-1">1st</option>
                            <option value="1-2">2nd</option>
                            <option value="2-1">3rd</option>
                            <option value="2-2">4th</option>
                            <option value="3-1">5th</option>
                            <option value="3-2">6th</option>
                            <option value="4-1">7th</option>
                            <option value="4-2">8th</option>
                        </select>
                    </div>
                    <div class="control">
                        <label>Section</label>
                        <select id="crInfoSection" disabled>
                            <option value="">Select Section</option>
                        </select>
                    </div>
                </div>
                <div id="crInfoResults" class="cr-info-results"></div>
            </div>
        </section>

        <!-- Bottom Navigation -->
        <nav class="tabbar" role="navigation" aria-label="Bottom Navigation">
            <button class="tab active" data-tab="student" aria-label="Student">
                <span class="tab-icon"><img src="attachment/student.png" alt="Student" class="tab-icon-img" id="student-icon"></span>
                <span class="tab-label">Student</span>
            </button>
            <button class="tab" data-tab="teacher" aria-label="Teacher">
                <span class="tab-icon"><img src="attachment/id-card (1).png" alt="Teacher" class="tab-icon-img" id="teacher-icon"></span>
                <span class="tab-label">Teacher</span>
            </button>
            <button class="tab" data-tab="query" aria-label="Query">
                <span class="tab-icon"><img src="attachment/history (1).png" alt="Query" class="tab-icon-img" id="query-icon"></span>
                <span class="tab-label">Query</span>
            </button>
        </nav>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Instant Lottie animation loader - runs immediately after Lottie library loads -->
    <script>
      (function() {
        // Function to start landing animation instantly
        function startLandingAnimation() {
          if (!window.lottie || typeof window.lottie.loadAnimation !== 'function') return;
          const lottieContainer = document.getElementById('lottie');
          if (!lottieContainer || lottieContainer.querySelector('svg')) return; // Already loaded
          
          // Use cached animation data if available (instant load)
          if (window.__landingAnimationData) {
            try {
              window.lottie.loadAnimation({
                container: lottieContainer,
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: window.__landingAnimationData
              });
              return;
            } catch (e) {}
          }
          
          // Fallback: try localStorage cache
          try {
            const cached = localStorage.getItem('cse.landingAnimationData');
            const cachedVersion = localStorage.getItem('cse.landingAnimationData.version');
            if (cached && cachedVersion === '1') {
              const animationData = JSON.parse(cached);
              window.__landingAnimationData = animationData;
              window.lottie.loadAnimation({
                container: lottieContainer,
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });
              return;
            }
          } catch (e) {}
          
          // Final fallback: use path
          try {
            window.lottie.loadAnimation({
              container: lottieContainer,
              renderer: 'svg',
              loop: true,
              autoplay: true,
              path: 'animation_file/loading.json'
            });
          } catch (e) {}
        }
        
        // Try to start immediately if Lottie is already loaded
        if (window.lottie && typeof window.lottie.loadAnimation === 'function') {
          startLandingAnimation();
        } else {
          // Wait for Lottie to load
          let checkCount = 0;
          const checkInterval = setInterval(() => {
            checkCount++;
            if (window.lottie && typeof window.lottie.loadAnimation === 'function') {
              startLandingAnimation();
              clearInterval(checkInterval);
            } else if (checkCount >= 50) {
              clearInterval(checkInterval);
            }
          }, 50);
        }
      })();
    </script>
    <!-- Firebase SDK (Compat for non-module setup) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <!-- Modular JavaScript files for better performance -->
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/utils.js"></script>
    <script src="app.js"></script>
    
    <!-- Quick loading page check script - runs immediately to avoid delays -->
    <script>
      (function() {
        // Immediately check localStorage and show/hide screens to prevent loading delay
        // This runs before app.js loads to ensure instant screen display
        try {
          const hasVisited = localStorage.getItem('cse.hasVisited') === '1';
          const department = localStorage.getItem('cse.department');
          const semester = localStorage.getItem('cse.semester');
          const section = localStorage.getItem('cse.section');
          
          const landingEl = document.getElementById('landing');
          const studentEl = document.getElementById('student');
          const studentLoadingOverlay = document.getElementById('studentLoadingOverlay');
          
          // If user has visited and has persisted selection, hide landing and show student immediately
          if (hasVisited && department && semester && section && landingEl && studentEl) {
            landingEl.classList.add('hidden');
            studentEl.classList.remove('hidden');
          } else if (landingEl) {
            // Ensure landing is visible for new users
            landingEl.classList.remove('hidden');
            if (studentEl) studentEl.classList.add('hidden');
            if (studentLoadingOverlay) studentLoadingOverlay.classList.add('hidden');
          }
        } catch (e) {
          // Silently fail if elements don't exist yet (they will be handled by app.js)
        }
      })();
    </script>
</body>
</html>

